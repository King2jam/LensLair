<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monster Transform ‚Äî PvPvE Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#111; --panel:#181a1f; --ink:#e8e8e8; --muted:#a6a6a6; --accent:#61dafb; --warn:#ffb020; --ok:#2ecc71; --bad:#ff5c5c;
      --btn:#262a33; --btn2:#1e2230;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--ink)}
    header{padding:16px 12px;text-align:center;border-bottom:1px solid #20242c;background:linear-gradient(180deg,#14161b,#0f1116)}
    h1{margin:6px 0 4px;font-size:22px}
    .sub{color:var(--muted);font-size:14px}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:960px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--panel);border:1px solid #23262f;border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.28)}
    video,canvas{width:100%;max-height:60vh;border-radius:10px;background:#000}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    button{
      appearance:none;border:1px solid #2a2e3a;background:var(--btn);color:var(--ink);padding:10px 14px;border-radius:10px;
      cursor:pointer;font-weight:600
    }
    button.primary{background:var(--btn2);border-color:#2f3646}
    button.bad{border-color:#3a2a2a;background:#2a1919}
    button:disabled{opacity:.55;cursor:not-allowed}
    .error{background:#3a1212;border:1px solid #5b1e1e;color:#ffdcdc;padding:10px;border-radius:8px;margin:8px 0;display:none}
    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .kvs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:10px}
    .kv{background:#20232b;padding:8px;border-radius:8px}
    .kv strong{display:block;font-size:12px;color:var(--muted)}
    .kv span{font-size:16px}
    .monster-card{display:flex;gap:14px;align-items:flex-start}
    .monster-card img{width:160px;height:160px;object-fit:contain;border-radius:12px;background:#0c0e12;border:1px solid #2a2e3a}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#222a;color:#cfe}
    hr.sep{border:0;border-top:1px solid #2a2e3a;margin:10px 0}
    .section-title{font-weight:700;margin:4px 0 8px}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .slot{padding:8px 10px;border:1px dashed #344;color:#bcd;border-radius:10px;min-width:88px;text-align:center;background:#131720}
    .slot.fill{border-style:solid;background:#1a1f2a}
    .small{font-size:12px}
    .footer{opacity:.7;text-align:center;padding:10px 0;font-size:12px}
    .soon{opacity:.6}
  </style>
</head>
<body>
  <header>
    <h1>Monster Transform</h1>
    <div class="sub">Snap real creatures ‚Üí unlock their monster forms. Build a team. PvPvE is coming soon.</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: Camera + Capture -->
      <section class="card">
        <div class="section-title">1) Capture</div>
        <div id="errorBox" class="error"></div>

        <video id="webcam" playsinline muted></video>
        <canvas id="frameCanvas" style="display:none"></canvas>

        <div class="btnrow">
          <button id="enableBtn" class="primary">üé• Enable Camera</button>
          <button id="captureBtn" disabled>üì∏ Capture Photo</button>
          <button id="flipBtn" title="Try front/back camera" disabled>üîÅ Flip</button>
          <button id="stopBtn" class="bad" disabled>‚èπ Stop</button>
        </div>

        <div class="small muted">
          Tip: iPhone requires HTTPS + tapping ‚ÄúEnable Camera‚Äù. Rear camera is preferred; use ‚ÄúFlip‚Äù if needed.
        </div>
      </section>

      <!-- RIGHT: Result / Card -->
      <section class="card" id="resultPanel">
        <div class="section-title">2) Monster Card</div>
        <div id="resultArea" class="muted">Take a photo to reveal your monster.</div>
      </section>
    </div>

    <div class="grid" style="margin-top:12px">
      <!-- LEFT: Team / Best Pal -->
      <section class="card">
        <div class="section-title">Team (3 slots) & Best Pal</div>
        <div id="teamRow" class="list"></div>
        <div class="btnrow" style="margin-top:8px">
          <button id="clearTeamBtn">üßπ Clear Team</button>
          <button id="clearAllBtn" class="bad">üóëÔ∏è Clear All Data</button>
        </div>
      </section>

      <!-- RIGHT: Coming soon / Shards -->
      <section class="card">
        <div class="section-title">Modes</div>
        <div class="btnrow">
          <button disabled class="soon">‚öîÔ∏è PvP (Online) ‚Äî Coming Soon</button>
          <button disabled class="soon">üõ°Ô∏è Co-Op Raids ‚Äî Coming Soon</button>
          <button disabled class="soon">üìñ Story ‚Äî Coming Soon</button>
        </div>
        <hr class="sep" />
        <div class="section-title">Your Shards</div>
        <div id="shardList" class="list small"></div>
      </section>
    </div>

    <div class="footer">Prototype saves to your device (localStorage). Add more monsters in the MONSTER_CONFIG section in this file.</div>
  </div>

  <!-- TFJS + Teachable Machine (pinned versions) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <script>
  /******************************************************************
   * SECTION: CONFIG ‚Äî EDIT HERE TO ADD MORE MONSTERS
   * Search for: MONSTER_CONFIG, RARITY_TABLE, ROLE_BASES, ELEMENT_MODS
   ******************************************************************/

  // Where your local TM model lives (exact filenames required).
  const MODEL_DIR = "model_real/";

  // Simple mapping helper: normalize TM labels to keys like "ladybug".
  const norm = s => String(s || "")
    .toLowerCase()
    .replace(/[^a-z0-9]/g, "");

  // === MONSTER_CONFIG =================================================
  // Add your new animals here. Key must match your TM label after normalize.
  // imageBase is the filename without extension; code will try .png ‚Üí .jpg ‚Üí .jpeg automatically.
  const MONSTER_CONFIG = {
    ladybug:  { display:"Ladybug",  role:"Tank",      element:"Light",  imageBase:"ladybug"  },
    squirrel: { display:"Squirrel", role:"Speedster", element:"Nature", imageBase:"squirrel" },
    dog:      { display:"Dog",      role:"Guardian",  element:"Earth",  imageBase:"dog"      },
    cat:      { display:"Cat",      role:"Assassin",  element:"Shadow", imageBase:"cat"      },
    spider:   { display:"Spider",   role:"Trapper",   element:"Poison", imageBase:"spider"   },
    fly:      { display:"Fly",      role:"Scout",     element:"Air",    imageBase:"fly"      }
  };

  // === RARITY_TABLE (probabilities sum to 100) =======================
  // Ensures "Rare" is < 5% as requested (we also have Epic & Legendary very low).
  const RARITY_TABLE = [
    { tier:"Common",    prob:70, mult:1.00, color:"#b8c4d6" },
    { tier:"Uncommon",  prob:25, mult:1.05, color:"#7cd992" },
    { tier:"Rare",      prob: 4, mult:1.15, color:"#5aa3ff" },
    { tier:"Epic",      prob: 0.9, mult:1.30, color:"#b889ff" },
    { tier:"Legendary", prob: 0.1, mult:1.50, color:"#ffb457" }
  ];

  // === ROLE_BASES (per role, min-max ranges) =========================
  // HP, ATK, DEF, SPD, CRIT, RESIST (percent; we display as % where makes sense).
  const ROLE_BASES = {
    Guardian:  { HP:[85,110], ATK:[40,60],  DEF:[70,95],  SPD:[35,55], CRIT:[5,10],  RESIST:[10,18] },
    Assassin:  { HP:[55,75],  ATK:[75,100], DEF:[35,55],  SPD:[80,100],CRIT:[18,28], RESIST:[5,10]  },
    Tank:      { HP:[100,130],ATK:[35,55],  DEF:[85,110], SPD:[30,45], CRIT:[4,8],   RESIST:[12,20] },
    Trapper:   { HP:[65,85],  ATK:[55,75],  DEF:[55,75],  SPD:[55,75], CRIT:[10,16], RESIST:[8,14]  },
    Scout:     { HP:[50,70],  ATK:[45,65],  DEF:[35,55],  SPD:[95,120],CRIT:[12,20], RESIST:[6,10]  },
    Speedster: { HP:[60,80],  ATK:[55,75],  DEF:[45,60],  SPD:[105,130],CRIT:[14,22],RESIST:[6,12]  }
  };

  // === ELEMENT_MODS (adds flavor by element) =========================
  // Values are additive (HP/ATK/DEF/SPD) or % points (CRIT/RESIST).
  const ELEMENT_MODS = {
    Nature:{ HP:+5,  ATK:+2, DEF:+4, SPD:+0,  CRIT:+0, RESIST:+2 },
    Earth: { HP:+8,  ATK:+0, DEF:+6, SPD:-2, CRIT:-1, RESIST:+3 },
    Shadow:{ HP:+0,  ATK:+6, DEF:-2,SPD:+2,  CRIT:+3, RESIST:+0 },
    Light: { HP:+4,  ATK:+2, DEF:+3, SPD:+0, CRIT:+1, RESIST:+2 },
    Poison:{ HP:+0,  ATK:+3, DEF:+1, SPD:+0, CRIT:+1, RESIST:+3 },
    Air:   { HP:-2,  ATK:+1, DEF:-1, SPD:+6, CRIT:+2, RESIST:+0 }
  };

  // === CLASS ADVANTAGE CHART (element vs element) ====================
  // Positive numbers = damage boost, negatives = resistance.
  const ELEM_ADV = {
    Nature:{ Air:+10, Poison:-10, Earth:+0, Light:+0, Shadow:+0, Nature:+0 },
    Earth: { Poison:+10, Air:-10, Nature:+0, Light:+0, Shadow:+0, Earth:+0 },
    Shadow:{ Light:+10, Nature:-10, Earth:+0, Poison:+0, Air:+0, Shadow:+0 },
    Light: { Shadow:+10, Poison:-10, Nature:+0, Earth:+0, Air:+0, Light:+0 },
    Poison:{ Nature:+10, Earth:-10, Air:+0, Light:+0, Shadow:+0, Poison:+0 },
    Air:   { Earth:+10, Nature:-10, Poison:+0, Light:+0, Shadow:+0, Air:+0 }
  };

  /******************************************************************
   * SECTION: STATE / STORAGE
   ******************************************************************/
  const $ = sel => document.querySelector(sel);
  const state = {
    stream: null,
    facing: "environment",
    model: null
  };

  const store = {
    getMonsters(){ return JSON.parse(localStorage.getItem("monsters")||"[]"); },
    setMonsters(v){ localStorage.setItem("monsters", JSON.stringify(v)); },
    getTeam(){ return JSON.parse(localStorage.getItem("team")||"[]"); }, // ids
    setTeam(v){ localStorage.setItem("team", JSON.stringify(v.slice(0,3))); },
    getFav(){ return localStorage.getItem("favoriteId") || ""; },
    setFav(id){ localStorage.setItem("favoriteId", id||""); },
    getShards(){ return JSON.parse(localStorage.getItem("shards")||"{}"); },
    setShards(v){ localStorage.setItem("shards", JSON.stringify(v)); },
    clearAll(){ localStorage.clear(); }
  };

  /******************************************************************
   * SECTION: UTILITIES
   ******************************************************************/
  // Weighted rarity roll
  function rollRarity(){
    const r = Math.random()*100;
    let acc=0;
    for(const t of RARITY_TABLE){ acc += t.prob; if(r < acc) return t; }
    return RARITY_TABLE[0];
  }
  // Random in [min,max]
  const rint = ([min,max]) => Math.round(min + Math.random()*(max-min));

  // Create unique id
  function uid(){ return Date.now().toString(36)+"-"+Math.random().toString(16).slice(2,8); }

  // Build stats from role + element + rarity
  function buildStats(role, element){
    const base = ROLE_BASES[role] || ROLE_BASES.Guardian;
    const rar = rollRarity();
    const mod = ELEMENT_MODS[element] || {HP:0,ATK:0,DEF:0,SPD:0,CRIT:0,RESIST:0};

    let stats = {
      HP: rint(base.HP) + mod.HP,
      ATK: rint(base.ATK) + mod.ATK,
      DEF: rint(base.DEF) + mod.DEF,
      SPD: rint(base.SPD) + mod.SPD,
      CRIT: rint(base.CRIT) + mod.CRIT,
      RESIST: rint(base.RESIST) + mod.RESIST
    };
    // Apply rarity multiplier to core stats (not to % rates too much).
    const coreMult = rar.mult;
    stats.HP = Math.round(stats.HP * coreMult);
    stats.ATK = Math.round(stats.ATK * coreMult);
    stats.DEF = Math.round(stats.DEF * coreMult);
    stats.SPD = Math.round(stats.SPD * coreMult);
    stats.RARITY = rar.tier;
    stats.RCOLOR = rar.color;
    return stats;
  }

  // Try .png ‚Üí .jpg ‚Üí .jpeg ‚Üí inline fallback
  function resolveImageSrc(base){
    const dir = "digital_images/";
    const cands = [".png",".jpg",".jpeg"].map(ext=>dir+base+ext);
    // We'll return the first candidate; <img onerror> will try the next.
    // The inline fallback is a data-URI SVG saying ‚ÄúMONSTER‚Äù.
    const fallback = 'data:image/svg+xml;utf8,'+encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="320" height="320">
        <rect width="100%" height="100%" fill="#0b0f16"/>
        <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#5aa3ff" font-size="28" font-family="Arial">MONSTER</text>
      </svg>`
    );
    return { cands, fallback };
  }

  function showError(msg){
    const el = $("#errorBox");
    el.textContent = msg;
    el.style.display = "block";
    console.error(msg);
  }
  function clearError(){ const el=$("#errorBox"); el.style.display="none"; el.textContent=""; }

  /******************************************************************
   * SECTION: CAMERA
   ******************************************************************/
  async function startCamera(facing = "environment"){
    if(!location.protocol.startsWith("https") && location.hostname!=="localhost"){
      showError("Camera requires HTTPS (GitHub Pages provides it). Open this page via https://");
      return;
    }
    clearError();
    stopCamera();
    try{
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: facing } }, audio: false
      });
      state.stream = stream;
      state.facing = facing;
      const video = $("#webcam");
      video.srcObject = stream;
      video.muted = true;
      await video.play();
      $("#captureBtn").disabled = false;
      $("#flipBtn").disabled = false;
      $("#stopBtn").disabled = false;
      return true;
    }catch(err){
      showError(`Camera error: ${err.name} ‚Äî ${err.message}`);
      return false;
    }
  }
  function stopCamera(){
    $("#captureBtn").disabled = true;
    $("#flipBtn").disabled = true;
    $("#stopBtn").disabled = true;
    const v = $("#webcam");
    if(state.stream){
      state.stream.getTracks().forEach(t=>t.stop());
      state.stream = null;
    }
    v.srcObject = null;
  }

  /******************************************************************
   * SECTION: MODEL LOAD
   ******************************************************************/
  async function loadModel(){
    try{
      // Optional quick existence check (helpful on GitHub Pages)
      for(const f of ["model.json","metadata.json","weights.bin"]){
        const res = await fetch(MODEL_DIR+f,{cache:"no-store"});
        if(!res.ok) console.warn(`Model file not accessible: ${f} (HTTP ${res.status})`);
      }
      state.model = await tmImage.load(MODEL_DIR+"model.json", MODEL_DIR+"metadata.json");
      console.log("‚úÖ TM model loaded");
      return true;
    }catch(err){
      showError("Failed to load model. Ensure model_real/ has model.json, metadata.json, weights.bin.");
      console.error(err);
      return false;
    }
  }

  /******************************************************************
   * SECTION: GAME / UI
   ******************************************************************/
  function renderTeam(){
    const row = $("#teamRow");
    row.innerHTML = "";
    const team = store.getTeam();
    const fav = store.getFav();

    for(let i=0;i<3;i++){
      const id = team[i];
      const div = document.createElement("div");
      div.className = "slot" + (id ? " fill" : "");
      if(!id){
        div.textContent = `Slot ${i+1}`;
      }else{
        const all = store.getMonsters();
        const m = all.find(x=>x.id===id);
        if(m){
          div.innerHTML = `<strong>${m.name}</strong><br><span class="small">${m.role} ‚Ä¢ ${m.element}</span><br><span class="small" style="color:${m.stats.RCOLOR}">${m.stats.RARITY}</span><br>${fav===id?'<span class="pill">Best Pal</span>':''}`;
        }else{
          div.textContent = `Slot ${i+1}`;
        }
      }
      row.appendChild(div);
    }
  }

  function renderShards(){
    const list = $("#shardList");
    const shards = store.getShards();
    list.innerHTML = "";
    Object.keys(shards).sort().forEach(k=>{
      const s = document.createElement("div");
      s.className = "slot fill";
      s.textContent = `${k}: ${shards[k]} shards`;
      list.appendChild(s);
    });
    if(!Object.keys(shards).length){
      const s = document.createElement("div");
      s.className = "slot";
      s.textContent = "No shards yet";
      list.appendChild(s);
    }
  }

  function cardHTML(mon){
    const advAgainst = Object.entries(ELEM_ADV[mon.element]||{})
      .filter(([,v])=>v>0).map(([k,v])=>`${k}+${v}%`).join(", ") || "‚Äî";
    const weakAgainst = Object.entries(ELEM_ADV[mon.element]||{})
      .filter(([,v])=>v<0).map(([k,v])=>`${k}${v}%`).join(", ") || "‚Äî";

    // Build image source with fallbacks
    const { cands, fallback } = resolveImageSrc(mon.imageBase);
    const img1 = cands[0], img2 = cands[1], img3 = cands[2];

    return `
      <div class="monster-card">
        <img id="monImg" src="${img1}"
             onerror="this.onerror=null; this.src='${img2}'; this.onerror=function(){this.onerror=null; this.src='${img3}'; this.onerror=function(){this.src='${fallback}'} }" alt="${mon.name}">
        <div>
          <div class="section-title" style="margin-top:2px">${mon.name}
            <span class="pill" style="margin-left:6px; background:${mon.stats.RCOLOR}22;border:1px solid ${mon.stats.RCOLOR}44;color:${mon.stats.RCOLOR}">
              ${mon.stats.RARITY}
            </span>
          </div>
          <div class="muted small">${mon.role} ‚Ä¢ ${mon.element}</div>
          <div class="kvs">
            <div class="kv"><strong>HP</strong><span>${mon.stats.HP}</span></div>
            <div class="kv"><strong>ATK</strong><span>${mon.stats.ATK}</span></div>
            <div class="kv"><strong>DEF</strong><span>${mon.stats.DEF}</span></div>
            <div class="kv"><strong>SPD</strong><span>${mon.stats.SPD}</span></div>
            <div class="kv"><strong>CRIT</strong><span>${mon.stats.CRIT}%</span></div>
            <div class="kv"><strong>RESIST</strong><span>${mon.stats.RESIST}%</span></div>
          </div>
          <div class="small" style="margin-top:8px">
            <strong>Advantage:</strong> ${advAgainst} &nbsp;&nbsp;
            <strong>Weak vs:</strong> ${weakAgainst}
          </div>
          <div class="btnrow" style="margin-top:10px">
            <button id="addTeamBtn">‚ûï Add to Team</button>
            <button id="favBtn">‚≠ê Set as Best Pal</button>
            <button id="breakBtn" class="bad">üß© Break Down (Shards)</button>
          </div>
          <div class="small muted">ID: ${mon.id}</div>
        </div>
      </div>
    `;
  }

  function saveAndShow(mon){
    const all = store.getMonsters();
    all.push(mon);
    store.setMonsters(all);

    $("#resultArea").innerHTML = cardHTML(mon);

    // Hook up buttons
    $("#addTeamBtn").onclick = ()=>{
      const team = store.getTeam();
      if(team.includes(mon.id)) return; // already in
      if(team.length>=3){ alert("Team full (3). Clear a slot first."); return; }
      team.push(mon.id);
      store.setTeam(team);
      renderTeam();
    };
    $("#favBtn").onclick = ()=>{
      store.setFav(mon.id);
      renderTeam();
      alert(`${mon.name} is now your Best Pal!`);
    };
    $("#breakBtn").onclick = ()=>{
      const shards = store.getShards();
      const key = mon.name;
      const yieldAmt = ({Common:1,Uncommon:2,Rare:5,Epic:10,Legendary:20})[mon.stats.RARITY] || 1;
      shards[key] = (shards[key]||0) + yieldAmt;
      store.setShards(shards);
      // remove from collection (not from team automatically)
      const rest = store.getMonsters().filter(x=>x.id!==mon.id);
      store.setMonsters(rest);
      renderShards();
      $("#resultArea").innerHTML = `<div class="ok">You gained ${yieldAmt} ${key} shards.</div>`;
    };
  }

  async function onCapture(){
    if(!state.model){ showError("Model not loaded yet."); return; }
    if(!state.stream){ showError("No webcam stream available."); return; }
    clearError();

    const video = $("#webcam");
    const cvs = $("#frameCanvas");
    const ctx = cvs.getContext("2d");
    cvs.width = video.videoWidth || 640;
    cvs.height = video.videoHeight || 480;
    ctx.drawImage(video, 0, 0, cvs.width, cvs.height);

    // Predict from canvas
    let pred;
    try{
      pred = await state.model.predict(cvs);
    }catch(err){
      showError("Prediction failed. Check model type (Image) and input.");
      console.error(err);
      return;
    }
    pred.sort((a,b)=>b.probability - a.probability);
    const top = pred[0];
    const key = norm(top.className);

    const cfg = MONSTER_CONFIG[key];
    if(!cfg){
      $("#resultArea").innerHTML = `<div class="warn">No config found for label ‚Äú${top.className}‚Äù. Add it under MONSTER_CONFIG to map an image & stats.</div>`;
      return;
    }

    const stats = buildStats(cfg.role, cfg.element);
    const monster = {
      id: uid(),
      label: top.className,
      name: cfg.display,
      role: cfg.role,
      element: cfg.element,
      stats,
      imageBase: cfg.imageBase
    };
    saveAndShow(monster);
  }

  /******************************************************************
   * SECTION: INIT & EVENTS
   ******************************************************************/
  (async function boot(){
    renderTeam();
    renderShards();

    // Load model immediately; user can start camera after tap.
    await loadModel();

    $("#enableBtn").onclick = ()=> startCamera(state.facing);
    $("#flipBtn").onclick = ()=> startCamera(state.facing==="environment" ? "user" : "environment");
    $("#stopBtn").onclick = ()=> stopCamera();
    $("#captureBtn").onclick = ()=> onCapture();
    $("#clearTeamBtn").onclick = ()=>{ store.setTeam([]); renderTeam(); };
    $("#clearAllBtn").onclick = ()=>{
      if(confirm("This will clear monsters, team, favorite and shards on this device. Continue?")){
        store.clearAll();
        renderTeam(); renderShards();
        $("#resultArea").textContent = "Data cleared.";
      }
    };
  })();
  </script>
</body>
</html>
  button.primary{background:var(--brand); border-color:transparent}
  button.ghost{background:transparent}
  button:disabled{opacity:.6; cursor:not-allowed}

  .error, .note{
    padding:10px 12px; border-radius:12px; margin-bottom:10px; white-space:pre-wrap
  }
  .error{background:#3a0d0d; border:1px solid #5c1515}
  .note{background:#102138; border:1px solid #1d3357; color:#cfe1ff}

  /* Right column */
  .statline{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:999px; font-size:12px}

  .team{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .team-slot{
    min-height:80px; background:var(--card); border:1px dashed #3a3a3a; border-radius:12px;
    display:flex; align-items:center; justify-content:center; padding:8px; text-align:center
  }
  .team-slot.filled{border-style:solid}
  .small{font-size:12px; color:var(--muted)}

  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; margin-top:10px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden
  }
  .card-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border)}
  .rarity{padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid var(--border); color:#ddd}
  .rarity.rare{background:#2b2142; border-color:#4b3780}
  .imgbox{background:#0b0b0b; height:140px; display:flex; align-items:center; justify-content:center}
  .imgbox img{max-width:100%; max-height:100%}
  .pad{padding:10px 12px}
  .kv{display:grid; grid-template-columns:auto 1fr auto 1fr; gap:6px 10px; font-size:13px}
  .act{display:flex; gap:8px; margin-top:8px}

  /* Footer nav (demo buttons) */
  .footer{display:flex; gap:10px; justify-content:center; padding:16px 0}
</style>
</head>
<body>
<div class="app">
  <h1>Monster Transform Game</h1>
  <div class="subtitle">Take a picture of a real creature and see its monster form!</div>

  <div id="httpsWarn" class="note" style="display:none">
    For mobile cameras you must be on <b>HTTPS</b> (e.g., GitHub Pages). iOS requires a user tap to start the camera.
  </div>

  <div class="layout">
    <!-- ===== Left: Capture / Predict ===== -->
    <div class="panel">
      <div id="log" class="error" style="display:none">No prediction result.</div>

      <div class="video-wrap">
        <video id="webcam" playsinline muted></video>
      </div>

      <div class="controls">
        <button id="btnEnable" class="primary">üì∑ Enable Camera</button>
        <button id="btnCapture">üß™ Capture Photo</button>
        <label class="ghost">
          <input id="fileInput" type="file" accept="image/*" hidden />
          ‚¨ÜÔ∏è Upload Photo
        </label>
        <button id="btnStop" class="ghost">‚úñ Stop Camera</button>
      </div>

      <div class="note small">
        Tip: On iOS, if the camera doesn‚Äôt appear, tap <b>Enable Camera</b> once more.  
        You can also test with <b>Upload Photo</b>.
      </div>
    </div>

    <!-- ===== Right: Collection / Team ===== -->
    <div class="panel">
      <div class="statline">
        <div class="chip">Upgrade Dust: <span id="dust">0</span></div>
        <div class="chip">Team: <span id="teamCount">0</span>/3</div>
        <div class="chip">Favorite: <span id="favName">None</span></div>
      </div>

      <h3 style="margin:8px 0 6px">Team</h3>
      <div id="team" class="team"></div>

      <h3 style="margin:12px 0 6px">Your Collection</h3>
      <div id="collection" class="cards"></div>
    </div>
  </div>

  <div class="footer">
    <button id="navCapture" class="primary">Capture</button>
    <button id="navCollection">Collection</button>
    <button id="navTeam">Team</button>
    <button id="navWild">Wild Battle</button>
    <button id="navPvp" disabled>Local PvP (soon)</button>
  </div>
</div>

<!-- ====== Libraries ====== -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

<!-- ====== Game Script ====== -->
<script>
/* -------------------------------------------------------------------------- */
/*  Configuration & Data                                                     */
/* -------------------------------------------------------------------------- */

// Model + assets
const MODEL_URL = "model_real/";
const IMG_DIR   = "digital_images/";

// Your current labels (must match Teachable Machine classes)
const MONSTER_BOOK = {
  dog:      { name:"Dog",      element:"earth",  archetype:"guardian" , img:"dog"      },
  cat:      { name:"Cat",      element:"shadow", archetype:"assassin" , img:"cat"      },
  squirrel: { name:"Squirrel", element:"nature", archetype:"skirmish" , img:"squirrel" },
  fly:      { name:"Fly",      element:"air",    archetype:"plague"   , img:"fly"      },
  spider:   { name:"Spider",   element:"poison", archetype:"control"  , img:"spider"   },
  ladybug:  { name:"Ladybug",  element:"light",  archetype:"paladin"  , img:"ladybug"  },
};

// Archetype base stats (starting points)
const ARCHETYPE_BASE = {
  guardian: { hp: 90, atk: 55, def: 75, spd: 40, crit: 5,  evade: 5,  control: 5,  dot: 0  },
  assassin: { hp: 55, atk: 85, def: 45, spd: 85, crit: 20, evade: 15, control: 5,  dot: 0  },
  skirmish: { hp: 75, atk: 65, def: 60, spd: 80, crit: 10, evade: 10, control: 5,  dot: 0  },
  plague:   { hp: 50, atk: 55, def: 45, spd: 95, crit: 8,  evade: 12, control: 5,  dot: 25 },
  control:  { hp: 65, atk: 60, def: 70, spd: 55, crit: 6,  evade: 8,  control: 30, dot: 10 },
  paladin:  { hp: 95, atk: 60, def: 85, spd: 35, crit: 5,  evade: 5,  control: 8,  dot: 0  },
};

// Element advantages (simple wheel + obvious counters)
// Advantage = +20% damage; disadvantage = -20%
const ELEMENT_ADV = {
  nature: ["earth"],        // roots crack stone
  earth:  ["air"],          // ground vs wind
  air:    ["poison"],       // dilute toxins
  poison: ["nature"],       // blight plants
  light:  ["shadow"],       // light dispels darkness
  shadow: ["light"],        // shadow consumes light (symmetry)
};

// Rarity
const RARITY = {
  COMMON: { label:"Common", mult:[1.00, 1.05] },
  RARE:   { label:"Rare",   mult:[1.20, 1.30] }, // 5% chance
};
const RARE_CHANCE = 0.05;

// Storage keys
const STORE = {
  COLLECTION: "ml_collection_v1",
  TEAM:       "ml_team_v1",
  DUST:       "ml_dust_v1",
  FAVORITE:   "ml_favorite_v1",
};

// Globals
let model = null;
let stream = null;
let videoEl = null;

/* -------------------------------------------------------------------------- */
/*  Utilities                                                                 */
/* -------------------------------------------------------------------------- */

const $ = sel => document.querySelector(sel);
const el = (tag, props={}, ...kids) => {
  const n = document.createElement(tag);
  Object.assign(n, props);
  for (const k of kids) n.append(k);
  return n;
};
const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const uid = ()=>`m_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;

function sample(multRange){ // pick a multiplier in [a,b]
  const [a,b] = multRange;
  return a + Math.random()*(b-a);
}

function modStats(base, mult){
  const s = {...base};
  for (const k of Object.keys(s)) s[k] = Math.max(1, Math.round(s[k]*mult));
  return s;
}

function headToHead(attacker, defender){
  // returns damage factor (element advantage)
  let factor = 1.0;
  if (ELEMENT_ADV[attacker.element]?.includes(defender.element)) factor *= 1.2;
  if (ELEMENT_ADV[defender.element]?.includes(attacker.element)) factor *= 0.8;
  return factor;
}

function resolveImage(labelOrKey){
  // Try several extensions in order: .png.jpeg, .png, .jpg, .jpeg
  const base = MONSTER_BOOK[labelOrKey]?.img || labelOrKey;
  const candidates = [
    `${IMG_DIR}${base}.png.jpeg`,
    `${IMG_DIR}${base}.png`,
    `${IMG_DIR}${base}.jpg`,
    `${IMG_DIR}${base}.jpeg`,
  ];
  return new Promise(async (res)=>{
    for (const path of candidates){
      try {
        const r = await fetch(path, {cache:"no-store"});
        if (r.ok) return res(path);
      } catch(_) {}
    }
    // fallback emoji image
    res("data:image/svg+xml;utf8," + encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='140'>
         <rect width='100%' height='100%' fill='#111'/>
         <text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle'
           font-size='28' fill='#888'>üß©</text>
       </svg>`
    ));
  });
}

function logError(msg){
  const box = $("#log");
  box.style.display = "block";
  box.textContent = msg;
}
function clearError(){ $("#log").style.display = "none"; }

/* -------------------------------------------------------------------------- */
/*  Storage                                                                   */
/* -------------------------------------------------------------------------- */

function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

const store = {
  get dust(){ return Number(localStorage.getItem(STORE.DUST) ?? 0); },
  set dust(v){ localStorage.setItem(STORE.DUST, String(v)); refreshHeader(); },

  get collection(){ return loadJSON(STORE.COLLECTION, []); },
  set collection(v){ saveJSON(STORE.COLLECTION, v); drawCollection(); },

  get team(){ return loadJSON(STORE.TEAM, []); },
  set team(v){ saveJSON(STORE.TEAM, v); drawTeam(); },

  get favorite(){ return localStorage.getItem(STORE.FAVORITE); },
  set favorite(id){ localStorage.setItem(STORE.FAVORITE, id ?? ""); refreshHeader(); },
};

function refreshHeader(){
  $("#dust").textContent = store.dust;
  $("#teamCount").textContent = store.team.length;
  const fav = store.collection.find(c=>c.id===store.favorite);
  $("#favName").textContent = fav ? fav.name : "None";
}

/* -------------------------------------------------------------------------- */
/*  Camera / Model                                                            */
/* -------------------------------------------------------------------------- */

async function loadModel(){
  try {
    // Quick sanity check that files exist
    for (const f of ["model.json","metadata.json","weights.bin"]){
      const r = await fetch(MODEL_URL + f, {cache:"no-store"});
      if (!r.ok) throw new Error(`Missing model file: ${f}`);
    }
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    console.log("Model loaded", model);
  } catch (err) {
    logError("Failed to load model: " + err.message);
  }
}

async function startCamera(){
  if (!isSecureContext) $("#httpsWarn").style.display = "block";
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal:"environment" },
        width: {ideal:1280}, height:{ideal:720}
      }, audio:false
    });
    videoEl.srcObject = stream;
    await videoEl.play();
    clearError();
  } catch (err) {
    logError(`Camera error: ${err.name} ‚Äî ${err.message}`);
  }
}
function stopCamera(){
  if (stream){
    for (const t of stream.getTracks()) t.stop();
    stream = null;
  }
  videoEl.pause();
  videoEl.removeAttribute("srcObject");
}

/* -------------------------------------------------------------------------- */
/*  Monster Generation                                                        */
/* -------------------------------------------------------------------------- */

function rollRarity(){
  return Math.random() < RARE_CHANCE ? "rare" : "common";
}

function buildStats(label){
  const spec = MONSTER_BOOK[label];
  if (!spec) return null;
  const base = ARCHETYPE_BASE[spec.archetype];
  if (!base) return null;

  const rar = rollRarity();
  const pack = rar === "rare" ? RARITY.RARE : RARITY.COMMON;
  const mult = sample(pack.mult);
  const stats = modStats(base, mult);

  return {
    element: spec.element,
    archetype: spec.archetype,
    rarity: rar,
    rarityLabel: pack.label,
    ...stats,
    level: 1, xp: 0
  };
}

async function makeMonsterFromLabel(label){
  const spec = MONSTER_BOOK[label];
  if (!spec) {
    logError(`No monster mapping for label "${label}"`);
    return null;
  }
  const stats = buildStats(label);
  const image = await resolveImage(label);
  return {
    id: uid(),
    label, name: spec.name,
    image, ...stats,
    caughtAt: Date.now()
  };
}

/* -------------------------------------------------------------------------- */
/*  Prediction                                                                */
/* -------------------------------------------------------------------------- */

async function predictFromCanvas(canvas){
  if (!model){ await loadModel(); if (!model) return; }
  const preds = await model.predict(canvas);
  preds.sort((a,b)=>b.probability-a.probability);
  const top = preds[0];
  if (!top) { logError("No prediction result."); return; }
  const label = top.className?.toLowerCase();
  if (!label){ logError("Empty predicted label."); return; }
  clearError();

  const monster = await makeMonsterFromLabel(label);
  if (!monster) return;

  // Add to collection
  const col = store.collection;
  col.unshift(monster);
  store.collection = col;
}

function drawFromVideo(){
  const c = document.createElement("canvas");
  c.width = videoEl.videoWidth || 640;
  c.height = videoEl.videoHeight || 480;
  c.getContext("2d").drawImage(videoEl, 0, 0, c.width, c.height);
  return c;
}

/* -------------------------------------------------------------------------- */
/*  UI: Collection / Team                                                     */
/* -------------------------------------------------------------------------- */

function drawTeam(){
  const root = $("#team");
  root.innerHTML = "";
  const team = store.team.map(id => store.collection.find(m=>m.id===id)).filter(Boolean);
  for (let i=0;i<3;i++){
    const mon = team[i];
    const slot = el("div",{className:"team-slot" + (mon?" filled":"")});
    if (mon){
      slot.append(
        el("div",{}, el("div",{style:"font-weight:700"}, mon.name),
          el("div",{className:"small"}, `Lv ${mon.level} ‚Ä¢ ${mon.element}`))
      );
    }else{
      slot.textContent = "Empty";
    }
    root.append(slot);
  }
  refreshHeader();
}

function drawCollection(){
  const root = $("#collection");
  root.innerHTML = "";
  for (const m of store.collection){
    const head = el("div",{className:"card-head"},
      el("div",{style:"font-weight:700; flex:1"}, `${m.name}`),
      el("span",{className:"rarity " + (m.rarity==="rare"?"rare":"")}, m.rarityLabel),
    );
    const img = el("div",{className:"imgbox"}, el("img",{src:m.image,alt:m.name}));
    const stats = el("div",{className:"pad"},
      el("div",{className:"kv"},
        el("div",{}, "HP"), el("div",{}, String(m.hp)),
        el("div",{}, "ATK"), el("div",{}, String(m.atk)),
        el("div",{}, "DEF"), el("div",{}, String(m.def)),
        el("div",{}, "SPD"), el("div",{}, String(m.spd)),
        el("div",{}, "CRIT"), el("div",{}, String(m.crit)),
        el("div",{}, "EVADE"), el("div",{}, String(m.evade)),
      ),
      el("div",{className:"small", style:"margin-top:6px"},
        `Element: ${m.element} ‚Ä¢ Archetype: ${m.archetype}`),
      el("div",{className:"act"},
        // Assign to team
        el("button",{onclick:()=>{
          const t = store.team.slice();
          if (t.includes(m.id)) {
            // remove
            const idx = t.indexOf(m.id); t.splice(idx,1);
          } else {
            if (t.length>=3) { alert("Team is full. Remove another first."); return; }
            t.push(m.id);
          }
          store.team = t;
        }}, store.team.includes(m.id) ? "Remove from Team" : "Add to Team"),

        // Favorite
        el("button",{onclick:()=>{ store.favorite = m.id; }}, store.favorite===m.id?"‚òÖ Favorite":"‚òÜ Make Favorite"),

        // Upgrade
        el("button",{onclick:()=>{
          const cost = 10 * m.level;
          if (store.dust < cost) { alert(`Need ${cost} dust.`); return; }
          store.dust = store.dust - cost;
          m.level += 1;
          m.hp = Math.round(m.hp * 1.06);
          m.atk = Math.round(m.atk * 1.05);
          m.def = Math.round(m.def * 1.05);
          m.spd = Math.round(m.spd * 1.03);
          store.collection = store.collection.map(x=>x.id===m.id?m:x);
        }}, "Upgrade"),

        // Break down
        el("button",{onclick:()=>{
          if (!confirm("Break down this monster for dust? This cannot be undone.")) return;
          const gain = m.rarity==="rare" ? 25 : 10;
          store.dust = store.dust + gain;
          store.collection = store.collection.filter(x=>x.id!==m.id);
          store.team = store.team.filter(id=>id!==m.id);
          if (store.favorite===m.id) store.favorite = "";
        }}, "Break Down"),
      )
    );
    const card = el("div",{className:"card"}, head, img, stats);
    root.append(card);
  }
  drawTeam();
}

/* -------------------------------------------------------------------------- */
/*  Wild Battle (local demo)                                                  */
/* -------------------------------------------------------------------------- */

function pickTeamFighter(){
  const team = store.team.map(id => store.collection.find(m=>m.id===id)).filter(Boolean);
  return team[0] || team[1] || team[2] || store.collection[0] || null;
}

function simulateBattle(a,b){
  // Simple score function using stats + element factor
  const f = headToHead(a,b);
  const aScore = a.atk*1.1 + a.def*0.9 + a.spd*0.8 + a.hp*0.8 + a.crit*0.5 + a.evade*0.5;
  const bScore = b.atk*1.1 + b.def*0.9 + b.spd*0.8 + b.hp*0.8 + b.crit*0.5 + b.evade*0.5;
  const aAdj = aScore * f * (1 + Math.random()*0.1);
  const bAdj = bScore * (1 + Math.random()*0.1);
  return aAdj >= bAdj ? "A" : "B";
}

async function wildBattle(){
  const me = pickTeamFighter();
  if (!me){ alert("You need a monster (or a team member) to fight!"); return; }

  // Make a random wild opponent from your book
  const labels = Object.keys(MONSTER_BOOK);
  const randLabel = labels[randInt(0,labels.length-1)];
  const foe = await makeMonsterFromLabel(randLabel);

  const who = simulateBattle(me, foe);
  const win = (who==="A");

  alert(`${me.name} (You) ${win ? "defeated" : "lost to"} ${foe.name} (Wild)!
${win ? "+10 dust earned." : "+3 dust earned."}`);

  store.dust = store.dust + (win ? 10 : 3);
}

/* -------------------------------------------------------------------------- */
/*  Wire-up                                                                   */
/* -------------------------------------------------------------------------- */

async function onCaptureClick(){
  if (stream && !videoEl.paused && !videoEl.ended){
    const c = drawFromVideo();
    await predictFromCanvas(c);
  }else{
    logError("No webcam stream available.");
  }
}

function onUploadFile(ev){
  const file = ev.target.files?.[0];
  if (!file) return;
  const img = new Image();
  img.onload = async ()=>{
    const c = document.createElement("canvas");
    c.width = img.width; c.height = img.height;
    c.getContext("2d").drawImage(img,0,0);
    await predictFromCanvas(c);
  };
  img.src = URL.createObjectURL(file);
}

async function boot(){
  videoEl = $("#webcam");
  refreshHeader();
  drawCollection();

  await loadModel(); // load early so first prediction is fast

  $("#btnEnable").addEventListener("click", startCamera);
  $("#btnStop").addEventListener("click", stopCamera);
  $("#btnCapture").addEventListener("click", onCaptureClick);
  $("#fileInput").addEventListener("change", onUploadFile);

  // Footer
  $("#navWild").addEventListener("click", wildBattle);
  $("#navCapture").addEventListener("click", ()=>window.scrollTo({top:0,behavior:"smooth"}));
  $("#navCollection").addEventListener("click", ()=>document.querySelector("#collection").scrollIntoView({behavior:"smooth"}));
  $("#navTeam").addEventListener("click", ()=>document.querySelector("#team").scrollIntoView({behavior:"smooth"}));

  if (!isSecureContext) $("#httpsWarn").style.display = "block";
}
boot();
</script>
</body>
</html>

