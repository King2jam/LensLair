<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Monster Transform Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- TFJS + Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

<style>
  :root{
    --bg:#151515; --panel:#1e1e1e; --muted:#aaaaaa; --hi:#2ea043; --err:#cc3333; --ink:#eaeaea;
    --accent:#3b82f6; --chip:#2a2a2a; --card:#222; --ring:#3a3a3a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 14px}
  h1{margin:0 0 8px;font-weight:800;text-align:center}
  .sub{margin:0 0 18px;text-align:center;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{
    appearance:none;border:1px solid #2a2a2a;background:#2b2b2b;color:#fff;
    padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600
  }
  .btn.primary{background:var(--accent);border-color:var(--accent)}
  .btn.green{background:var(--hi);border-color:var(--hi)}
  .btn.red{background:#b91c1c;border-color:#b91c1c}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-flex;gap:8px;align-items:center;background:var(--chip);border:1px solid var(--ring);padding:6px 10px;border-radius:999px;color:#ddd;font-size:13px}
  .log{white-space:pre-wrap;background:#0f0f0f;border:1px solid #2a2a2a;border-radius:10px;padding:10px;margin-top:10px;min-height:44px}
  .error{background:#2b0e0e;border-color:#5e1a1a;color:#ffb4b4}
  .success{background:#0e2b14;border-color:#1a5e2b;color:#c6ffd6}
  .stack{display:flex;flex-direction:column;gap:8px}
  .mediaBox{background:#000;border:2px solid #fff;border-radius:12px;overflow:hidden;min-height:220px}
  video,canvas{display:block;width:100%;height:auto;background:#000}
  input[type=file]{display:none}
  label.file{border:1px dashed #3a3a3a;background:#1a1a1a;color:#ddd;padding:10px 12px;border-radius:10px;cursor:pointer}
  select{background:#1d1d1d;color:#eee;border:1px solid #333;border-radius:8px;padding:8px 10px}
  /* Cards */
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:14px;overflow:hidden}
  .card .art{display:block;width:100%;height:140px;object-fit:cover;background:#111}
  .card .pad{padding:10px}
  .statrow{display:grid;grid-template-columns:1fr auto;gap:6px;margin:4px 0;color:#ddd}
  .rar{font-weight:800}
  .rar.Common{color:#cbd5e1}
  .rar.Uncommon{color:#86efac}
  .rar.Rare{color:#60a5fa}
  .rar.Epic{color:#c084fc}
  .rar.Legendary{color:#fbbf24}
  .flex{display:flex;gap:8px;flex-wrap:wrap}
  .split{display:flex;align-items:center;justify-content:space-between}
  .empty{color:#9ca3af;padding:12px;border:1px dashed #3a3a3a;border-radius:10px;text-align:center}
</style>
</head>

<body>
  <div class="wrap">
    <h1>Monster Transform Game</h1>
    <p class="sub">Capture a real creature and see its monster form. Works on desktop, Android, and iPhone (HTTPS).</p>

    <div class="grid">
      <!-- LEFT: Capture -->
      <section class="panel">
        <div class="stack">
          <div id="topMsg" class="pill">No prediction yet.</div>

          <div class="mediaBox">
            <video id="webcam" playsinline autoplay muted></video>
            <canvas id="canvas" style="display:none;"></canvas>
          </div>

          <div class="row">
            <button id="btnEnable" class="btn primary">üì∑ Enable Camera</button>
            <button id="btnCapture" class="btn green" disabled>üñºÔ∏è Capture Photo</button>

            <label for="file" class="file">‚¨ÜÔ∏è Upload Photo</label>
            <input id="file" type="file" accept="image/*;capture=camera" />
            <select id="deviceSelect" title="Camera device"></select>
          </div>

          <div id="log" class="log">Ready.</div>
        </div>
      </section>

      <!-- RIGHT: Collection & Team -->
      <section class="panel">
        <div class="split" style="margin-bottom:8px">
          <h3 style="margin:0">Your Collection</h3>
          <div class="flex">
            <span class="pill">Upgrade Dust: <b id="dust">0</b></span>
            <span class="pill">Team: <b id="teamCount">0</b>/3</span>
          </div>
        </div>

        <div class="stack">
          <div class="cards" id="team"></div>
          <div class="empty" id="teamEmpty">No monsters in your team. Add some from inventory below.</div>

          <h4 style="margin:8px 0 2px">Inventory</h4>
          <div class="cards" id="inventory"></div>
          <div class="empty" id="invEmpty">You have no stored monsters yet.</div>
        </div>
      </section>
    </div>

    <!-- Quick actions (future) -->
    <div class="panel" style="margin-top:14px;text-align:center">
      <div class="row" style="justify-content:center">
        <button class="btn">Collection</button>
        <button class="btn">Team</button>
        <button class="btn">Wild Battle</button>
        <button class="btn" disabled title="Coming soon">Online PvP (soon)</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG & CONSTANTS
 *  ========================= */
const MODEL_URL = "model_real/";
const DIGITAL_ART = {
  // filename per label (lowercase)
  "dog": "digital_images/dog.jpeg",
  "cat": "digital_images/cat.jpeg",
  "spider": "digital_images/spider.jpeg",
  "squirrel": "digital_images/squirrel.jpeg",
  "fly": "digital_images/fly.jpeg",
  "ladybug": "digital_images/ladybug.jpeg",
};

// class/element suggestions
const SPECIES_CLASS = {
  dog:      {class:"Guardian", element:"Earth"},
  cat:      {class:"Assassin", element:"Shadow"},
  squirrel: {class:"Tank", element:"Nature"},
  fly:      {class:"Scout", element:"Air"},
  spider:   {class:"Trapper", element:"Poison"},
  ladybug:  {class:"Tank", element:"Light"}
};

// base stat templates by class (balance knobs)
const CLASS_BASES = {
  Guardian: {hp:70, atk:50, def:70, spd:45, crit:5},
  Assassin: {hp:45, atk:75, def:40, spd:75, crit:15},
  Tank:     {hp:85, atk:45, def:80, spd:35, crit:3},
  Scout:    {hp:50, atk:45, def:40, spd:90, crit:10},
  Trapper:  {hp:55, atk:55, def:50, spd:55, crit:8},
  Light:    {hp:60, atk:50, def:60, spd:50, crit:7}, // used for ladybug Tank (element only)
  Poison:   {hp:55, atk:55, def:50, spd:55, crit:8}, // used for element flavor
};

// rarity odds & multipliers
const RARITY_TABLE = [
  {name:"Common",    weight:60, mult:{hp:1.00, atk:1.00, def:1.00, spd:1.00, crit:+0}},
  {name:"Uncommon",  weight:30, mult:{hp:1.05, atk:1.05, def:1.05, spd:1.05, crit:+1}},
  {name:"Rare",      weight:7,  mult:{hp:1.12, atk:1.12, def:1.12, spd:1.10, crit:+2}},
  {name:"Epic",      weight:2.5,mult:{hp:1.20, atk:1.20, def:1.18, spd:1.15, crit:+4}},
  {name:"Legendary", weight:0.5,mult:{hp:1.30, atk:1.30, def:1.25, spd:1.20, crit:+6}},
];

const TEAM_MAX = 3;
const LS_KEYS = {
  inventory: "ml_inventory",
  team: "ml_team",
  dust: "ml_dust"
};

/** =========================
 *  STATE
 *  ========================= */
let model = null;
let webcamStream = null;
let deviceList = [];
let currentDeviceId = null;

// persistent state
let inventory = loadLS(LS_KEYS.inventory, []);
let team = loadLS(LS_KEYS.team, []);
let upgradeDust = loadLS(LS_KEYS.dust, 0);

/** =========================
 *  DOM
 *  ========================= */
const $ = s => document.querySelector(s);
const logEl   = $("#log");
const topMsg  = $("#topMsg");
const videoEl = $("#webcam");
const canvas  = $("#canvas");
const fileInp = $("#file");
const btnEnable  = $("#btnEnable");
const btnCapture = $("#btnCapture");
const selDevices = $("#deviceSelect");

const teamWrap = $("#team");
const invWrap  = $("#inventory");
const teamEmpty = $("#teamEmpty");
const invEmpty  = $("#invEmpty");
const dustEl    = $("#dust");
const teamCount = $("#teamCount");

/** =========================
 *  UTIL
 *  ========================= */
function log(msg, kind="info"){
  if(kind==="error") logEl.classList.add("error"), logEl.classList.remove("success");
  else if(kind==="success") logEl.classList.add("success"), logEl.classList.remove("error");
  else logEl.classList.remove("error","success");
  logEl.textContent = msg;
}

function uid(){
  // lightweight UUIDv4
  return ([1e7]+-1e3+-4e3+-8e3+-1e11)
    .replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
}

function saveLS(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadLS(key, fallback){
  try{ const v = JSON.parse(localStorage.getItem(key)); return (v===null?fallback:v); }
  catch{ return fallback; }
}

function weightedPick(table){
  const total = table.reduce((a,b)=>a+b.weight,0);
  let r = Math.random()*total;
  for(const item of table){
    if((r-=item.weight) <= 0) return item;
  }
  return table[0];
}

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/** =========================
 *  MODEL LOADING
 *  ========================= */
(async function loadModel(){
  try{
    // quick file presence probe (helps debug 404s)
    const files = ["model.json","metadata.json","weights.bin"];
    for(const f of files){
      const res = await fetch(MODEL_URL + f, {cache:"no-store"});
      if(!res.ok) console.warn("Model file not accessible:", f, res.status);
    }
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    topMsg.textContent = "Model loaded. Enable camera to start.";
    log("Model loaded successfully.", "success");
  }catch(err){
    topMsg.textContent = "Model failed to load.";
    log("Model load error: " + err.message, "error");
  }
})();

/** =========================
 *  CAMERA SETUP
 *  ========================= */
async function enumerateCameras(){
  try{
    const all = await navigator.mediaDevices.enumerateDevices();
    deviceList = all.filter(d => d.kind === "videoinput");
    selDevices.innerHTML = "";
    deviceList.forEach((d,i)=>{
      const opt = document.createElement("option");
      opt.value = d.deviceId;
      opt.textContent = d.label || `Camera ${i+1}`;
      selDevices.appendChild(opt);
    });
    if (deviceList.length === 0) {
      const opt = document.createElement("option");
      opt.textContent = "No cameras";
      opt.value = "";
      selDevices.appendChild(opt);
    }
  }catch(e){
    console.warn("enumerateDevices failed", e);
  }
}

async function startCamera(deviceId=null){
  stopCamera();

  // iOS/Safari quirks
  videoEl.setAttribute("playsinline","true");
  videoEl.setAttribute("muted","true");
  videoEl.muted = true;

  const base = deviceId ? {deviceId:{exact:deviceId}} : {facingMode:{ideal:"environment"}};
  const constraints = { video: { ...base }, audio:false };

  try{
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    webcamStream = stream;
    videoEl.srcObject = stream;
    await videoEl.play();
    btnCapture.disabled = false;
    topMsg.textContent = "Camera ready.";
    log("Camera started.", "success");

    await enumerateCameras();
    if(!deviceId && deviceList.length){
      // remember the chosen deviceId
      currentDeviceId = stream.getVideoTracks()[0].getSettings().deviceId || deviceList[0].deviceId;
      selDevices.value = currentDeviceId || "";
    }
  }catch(err){
    // Helpful error messages
    let help = err.name + ": " + err.message;
    if(err.name === "NotAllowedError") help += "\n‚Ä¢ Allow camera permission in the browser settings.";
    if(err.name === "NotReadableError") help += "\n‚Ä¢ Another app may be using the camera. Close other apps and try again.";
    if(err.name === "OverconstrainedError") help += "\n‚Ä¢ The requested camera wasn't found. Try selecting a different one from the dropdown.";
    if(location.protocol !== "https:") help += "\n‚Ä¢ iOS/Android need HTTPS to use the camera (GitHub Pages is HTTPS).";

    log("Camera error: " + help, "error");
    topMsg.textContent = "Camera unavailable. You can still Upload Photo.";
    btnCapture.disabled = true;
  }
}

function stopCamera(){
  if(webcamStream){
    webcamStream.getTracks().forEach(t => t.stop());
    webcamStream = null;
  }
  btnCapture.disabled = true;
}

// UI handlers
btnEnable.addEventListener("click", async ()=>{
  await startCamera(currentDeviceId);
});

selDevices.addEventListener("change", async (e)=>{
  const id = e.target.value || null;
  currentDeviceId = id;
  await startCamera(id);
});

window.addEventListener("pagehide", stopCamera);

/** =========================
 *  CAPTURE / UPLOAD / PREDICT
 *  ========================= */
btnCapture.addEventListener("click", async ()=>{
  if(!webcamStream){ log("No camera stream. Try Enable Camera.", "error"); return; }
  await captureAndPredictFromVideo();
});

fileInp.addEventListener("change", async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const img = new Image();
  img.onload = async ()=>{ await predictFromElement(img); };
  img.onerror = ()=> log("Could not load selected image.", "error");
  img.src = URL.createObjectURL(file);
});

async function captureAndPredictFromVideo(){
  try{
    const {videoWidth:w, videoHeight:h} = videoEl;
    if(!w || !h){ log("Camera not ready yet. Try again.", "error"); return; }
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(videoEl, 0, 0, w, h);
    await predictFromElement(canvas);
  }catch(err){
    log("Capture error: " + err.message, "error");
  }
}

async function predictFromElement(sourceEl){
  if(!model){ log("Model not loaded yet.", "error"); return; }

  try{
    const preds = await model.predict(sourceEl);
    preds.sort((a,b)=>b.probability - a.probability);
    const top = preds[0];

    if(!top || !top.className){
      topMsg.textContent = "No recognizable creature.";
      log("Prediction returned no class.", "error");
      return;
    }

    const species = (top.className || "").toLowerCase().trim();
    const prob = top.probability;

    // build monster record
    const mon = buildMonster(species, prob);
    addToInventory(mon);

    topMsg.textContent = `Detected: ${species} (${(prob*100).toFixed(1)}%) ‚Üí added to Inventory`;
    log(`Created ${mon.name} [${mon.rarity}] with stats ‚Äî now in inventory.`, "success");
  }catch(err){
    log("Prediction failed: " + err.message, "error");
  }
}

/** =========================
 *  MONSTER FACTORY
 *  ========================= */
function buildMonster(species, conf){
  const id = uid();
  const pretty = species.charAt(0).toUpperCase() + species.slice(1);
  const cls = SPECIES_CLASS[species]?.class || "Guardian";
  const elem = SPECIES_CLASS[species]?.element || "Neutral";

  const baseTemplate = CLASS_BASES[cls] || CLASS_BASES.Guardian;

  // rarity roll
  const rare = weightedPick(RARITY_TABLE);
  const m = rare.mult;

  // randomness ¬±10% and small bonus if high confidence
  const jitter = () => (0.9 + Math.random()*0.2);
  const confBoost = 1 + Math.min(0.10, Math.max(0, conf - 0.8)); // up to +10% if conf > 0.8

  const hp  = Math.round(baseTemplate.hp  * m.hp  * jitter() * confBoost);
  const atk = Math.round(baseTemplate.atk * m.atk * jitter() * confBoost);
  const def = Math.round(baseTemplate.def * m.def * jitter() * confBoost);
  const spd = Math.round(baseTemplate.spd * m.spd * jitter() * confBoost);
  const crit= clamp((baseTemplate.crit + (m.crit||0) + Math.round(Math.random()*3)), 1, 40);

  const art = DIGITAL_ART[species] || DIGITAL_ART["dog"]; // fallback

  return {
    id, species, name: pretty,
    class: cls, element: elem, rarity: rare.name,
    stats: {hp, atk, def, spd, crit},
    art, level: 1, exp: 0, createdAt: Date.now()
  };
}

/** =========================
 *  COLLECTION MGMT
 *  ========================= */
function addToInventory(mon){
  inventory.push(mon);
  saveLS(LS_KEYS.inventory, inventory);
  renderCollection();
}

function moveToTeam(id){
  if(team.length >= TEAM_MAX){ log("Team is full.", "error"); return; }
  const idx = inventory.findIndex(m => m.id === id);
  if(idx === -1) return;
  const mon = inventory.splice(idx,1)[0];
  team.push(mon);
  saveLS(LS_KEYS.inventory, inventory);
  saveLS(LS_KEYS.team, team);
  renderCollection();
}

function removeFromTeam(id){
  const idx = team.findIndex(m => m.id === id);
  if(idx === -1) return;
  const mon = team.splice(idx,1)[0];
  inventory.push(mon);
  saveLS(LS_KEYS.inventory, inventory);
  saveLS(LS_KEYS.team, team);
  renderCollection();
}

function salvage(id){
  // convert inventory monster into dust
  const idx = inventory.findIndex(m => m.id === id);
  if(idx === -1){ log("Only stored (inventory) monsters can be salvaged.", "error"); return; }
  const mon = inventory.splice(idx,1)[0];
  // rarity -> dust yield
  const yieldMap = {Common:5, Uncommon:10, Rare:25, Epic:60, Legendary:120};
  upgradeDust += (yieldMap[mon.rarity] || 5);
  saveLS(LS_KEYS.inventory, inventory);
  saveLS(LS_KEYS.dust, upgradeDust);
  renderCollection();
  log(`Salvaged ${mon.name} (${mon.rarity}) ‚Üí +${yieldMap[mon.rarity]||5} dust.`, "success");
}

/** =========================
 *  RENDER
 *  ========================= */
function cardHTML(m, where){
  // where = "inventory" or "team"
  return `
    <div class="card">
      <img class="art" src="${m.art}" alt="${m.name}">
      <div class="pad">
        <div class="split"><b>${m.name}</b> <span class="rar ${m.rarity}">${m.rarity}</span></div>
        <div style="margin:4px 0 6px;color:#9ca3af">${m.class} ‚Ä¢ ${m.element}</div>
        <div class="statrow"><span>HP</span><b>${m.stats.hp}</b></div>
        <div class="statrow"><span>ATK</span><b>${m.stats.atk}</b></div>
        <div class="statrow"><span>DEF</span><b>${m.stats.def}</b></div>
        <div class="statrow"><span>SPD</span><b>${m.stats.spd}</b></div>
        <div class="statrow"><span>CRIT%</span><b>${m.stats.crit}</b></div>
        <div class="row" style="margin-top:8px">
          ${where==="inventory"
            ? `<button class="btn green" onclick="moveToTeam('${m.id}')">Add to Team</button>
               <button class="btn red" onclick="salvage('${m.id}')">Salvage</button>`
            : `<button class="btn" onclick="removeFromTeam('${m.id}')">Send to Inventory</button>`
          }
        </div>
      </div>
    </div>
  `;
}

function renderCollection(){
  // counters
  dustEl.textContent = upgradeDust;
  teamCount.textContent = team.length;

  // team
  teamWrap.innerHTML = team.map(m => cardHTML(m,"team")).join("");
  teamEmpty.style.display = team.length ? "none" : "block";

  // inventory
  invWrap.innerHTML  = inventory.map(m => cardHTML(m,"inventory")).join("");
  invEmpty.style.display = inventory.length ? "none" : "block";
}
renderCollection();

/** =========================
 *  HELPER: iOS Auto-Start Hint
 *  ========================= */
document.addEventListener("visibilitychange", ()=>{
  if(document.visibilityState === "visible" && webcamStream && videoEl.paused){
    videoEl.play().catch(()=>{});
  }
});
</script>
</body>
</html>
