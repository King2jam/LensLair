<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monster Transform Game - Debug Mode</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #222; color: #fff; }
        h1 { margin-top: 20px; }
        video, img { max-width: 90%; margin-top: 10px; border: 4px solid #fff; border-radius: 10px; }
        button { padding: 10px 20px; font-size: 16px; margin-top: 15px; cursor: pointer; border-radius: 5px; }
        .monster-card { margin-top: 20px; padding: 15px; background: #333; border-radius: 10px; display: inline-block; }
        .monster-card img { width: 200px; height: auto; border-radius: 10px; }
        .stats { margin-top: 10px; text-align: left; }
        #errorLog { background: #a00; padding: 10px; border-radius: 5px; margin: 10px; display: none; }
    </style>
</head>
<body>
    <h1>Monster Transform Game</h1>
    <p>Take a picture of an animal to see its monster form!</p>

    <div id="errorLog"></div>

    <video id="webcam" autoplay playsinline></video><br>
    <button id="captureBtn">üì∏ Capture Photo</button>
    <canvas id="canvas" style="display:none;"></canvas>

    <div id="result"></div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>
<script>
  const URL = "model_real/";

  // Debug: check that the 3 model files are actually being served
  (async () => {
    const files = ["model.json", "metadata.json", "weights.bin"];
    for (const file of files) {
      try {
        const res = await fetch(`${URL}${file}`, { cache: "no-store" });
        if (res.ok) console.log(`‚úÖ Found: ${file}`);
        else console.error(`‚ùå Missing or not accessible: ${file} (HTTP ${res.status})`);
      } catch (err) {
        console.error(`‚ö†Ô∏è Error fetching ${file}:`, err);
      }
    }
  })();

  let model, webcamStream;

  const monsterData = {
    ladybug:  { image: "digital_images/ladybug.png.jpeg",  type: "Tank" },
    squirrel: { image: "digital_images/squirrel.png.jpeg", type: "Rogue" },
    dog:      { image: "digital_images/dog.png.jpeg",      type: "Brawler" },
    cat:      { image: "digital_images/cat.png.jpeg",      type: "Assassin" },
    spider:   { image: "digital_images/spider.png.jpeg",   type: "Trapper" },
    fly:      { image: "digital_images/fly.png.jpeg",      type: "Scout" }
  };

  function logError(msg) {
    const logBox = document.getElementById("errorLog");
    logBox.style.display = "block";
    logBox.innerHTML = `<strong>Error:</strong> ${msg}`;
    console.error(msg);
  }

  async function init() {
    // 1) Load model
    try {
      model = await tmImage.load(`${URL}model.json`, `${URL}metadata.json`);
      console.log("‚úÖ Model loaded successfully");
    } catch (err) {
      logError("Failed to load model: " + err.message +
               " ‚Äî Check that model_real/ contains model.json, metadata.json, weights.bin.");
      return;
    }

    // 2) Start camera: try rear, fallback to front
    try {
      let constraints = { video: { facingMode: { ideal: "environment" } } };
      try {
        webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log("‚úÖ Rear camera started successfully");
      } catch (rearErr) {
        console.warn("Rear camera failed, trying front camera...", rearErr);
        constraints = { video: { facingMode: "user" } };
        webcamStream = await navigator.mediaDevices.getUserMedia(constraints);
        console.log("‚úÖ Front camera started successfully");
      }
      document.getElementById("webcam").srcObject = webcamStream;
    } catch (err) {
      logError(`Camera could not start: ${err.name} ‚Äî ${err.message}`);
      console.error("Full camera error:", err);
      return;
    }
  }

  document.getElementById("captureBtn").addEventListener("click", async () => {
    if (!webcamStream) {
      logError("No webcam stream available.");
      return;
    }
    const videoElement = document.getElementById("webcam");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = videoElement.videoWidth;
    canvas.height = videoElement.videoHeight;
    ctx.drawImage(videoElement, 0, 0);

    // Stop camera to ‚Äúfreeze‚Äù the capture
    webcamStream.getTracks().forEach(track => track.stop());

    try {
      const prediction = await model.predict(canvas);
      prediction.sort((a, b) => b.probability - a.probability);
      const top = prediction[0]?.className?.toLowerCase();
      if (top && monsterData[top]) {
        showMonster(top);
      } else {
        document.getElementById("result").innerHTML =
          `<p>No matching monster found for "${top ?? "unknown"}".</p>`;
      }
    } catch (err) {
      logError("Prediction failed: " + err.message);
      console.error("Prediction error:", err);
    }
  });

  function showMonster(name) {
    const monster = monsterData[name];
    const health = Math.floor(Math.random() * 51) + 50;
    const attack = Math.floor(Math.random() * 51) + 20;
    document.getElementById("result").innerHTML = `
      <div class="monster-card">
        <h2>${name.toUpperCase()} ‚Äî ${monster.type}</h2>
        <img src="${monster.image}" alt="${name}">
        <div class="stats">
          <p><strong>Health:</strong> ${health}</p>
          <p><strong>Attack:</strong> ${attack}</p>
        </div>
      </div>
    `;
  }

  init();
</script>
