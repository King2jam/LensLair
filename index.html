<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Monster Transform Game</title>

<!-- ====== Styles ====== -->
<style>
  :root{
    --bg:#121212; --panel:#1b1b1b; --ink:#f5f5f5; --muted:#9aa0a6;
    --brand:#4f8cff; --ok:#17c964; --warn:#ffb020; --bad:#ef4444;
    --chip:#2a2a2a; --card:#202225; --border:#2c2c2c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  .app{max-width:1100px; margin:0 auto; padding:16px}
  h1{font-size:24px; margin:4px 0 12px}
  .subtitle{color:var(--muted); margin-bottom:12px}

  .layout{display:grid; grid-template-columns:1.1fr .9fr; gap:16px}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }

  .panel{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px}

  .video-wrap{position:relative; background:#000; border-radius:12px; overflow:hidden; border:1px solid var(--border)}
  video{width:100%; height:320px; object-fit:cover; background:#000}
  .controls{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
  button{
    background:#2b2b2b; border:1px solid var(--border); color:var(--ink);
    padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
  }
  button.primary{background:var(--brand); border-color:transparent}
  button.ghost{background:transparent}
  button:disabled{opacity:.6; cursor:not-allowed}

  .error, .note{
    padding:10px 12px; border-radius:12px; margin-bottom:10px; white-space:pre-wrap
  }
  .error{background:#3a0d0d; border:1px solid #5c1515}
  .note{background:#102138; border:1px solid #1d3357; color:#cfe1ff}

  /* Right column */
  .statline{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:999px; font-size:12px}

  .team{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
  .team-slot{
    min-height:80px; background:var(--card); border:1px dashed #3a3a3a; border-radius:12px;
    display:flex; align-items:center; justify-content:center; padding:8px; text-align:center
  }
  .team-slot.filled{border-style:solid}
  .small{font-size:12px; color:var(--muted)}

  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px; margin-top:10px}
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden
  }
  .card-head{display:flex; align-items:center; gap:8px; padding:10px 12px; border-bottom:1px solid var(--border)}
  .rarity{padding:2px 6px; border-radius:999px; font-size:11px; border:1px solid var(--border); color:#ddd}
  .rarity.rare{background:#2b2142; border-color:#4b3780}
  .imgbox{background:#0b0b0b; height:140px; display:flex; align-items:center; justify-content:center}
  .imgbox img{max-width:100%; max-height:100%}
  .pad{padding:10px 12px}
  .kv{display:grid; grid-template-columns:auto 1fr auto 1fr; gap:6px 10px; font-size:13px}
  .act{display:flex; gap:8px; margin-top:8px}

  /* Footer nav (demo buttons) */
  .footer{display:flex; gap:10px; justify-content:center; padding:16px 0}
</style>
</head>
<body>
<div class="app">
  <h1>Monster Transform Game</h1>
  <div class="subtitle">Take a picture of a real creature and see its monster form!</div>

  <div id="httpsWarn" class="note" style="display:none">
    For mobile cameras you must be on <b>HTTPS</b> (e.g., GitHub Pages). iOS requires a user tap to start the camera.
  </div>

  <div class="layout">
    <!-- ===== Left: Capture / Predict ===== -->
    <div class="panel">
      <div id="log" class="error" style="display:none">No prediction result.</div>

      <div class="video-wrap">
        <video id="webcam" playsinline muted></video>
      </div>

      <div class="controls">
        <button id="btnEnable" class="primary">üì∑ Enable Camera</button>
        <button id="btnCapture">üß™ Capture Photo</button>
        <label class="ghost">
          <input id="fileInput" type="file" accept="image/*" hidden />
          ‚¨ÜÔ∏è Upload Photo
        </label>
        <button id="btnStop" class="ghost">‚úñ Stop Camera</button>
      </div>

      <div class="note small">
        Tip: On iOS, if the camera doesn‚Äôt appear, tap <b>Enable Camera</b> once more.  
        You can also test with <b>Upload Photo</b>.
      </div>
    </div>

    <!-- ===== Right: Collection / Team ===== -->
    <div class="panel">
      <div class="statline">
        <div class="chip">Upgrade Dust: <span id="dust">0</span></div>
        <div class="chip">Team: <span id="teamCount">0</span>/3</div>
        <div class="chip">Favorite: <span id="favName">None</span></div>
      </div>

      <h3 style="margin:8px 0 6px">Team</h3>
      <div id="team" class="team"></div>

      <h3 style="margin:12px 0 6px">Your Collection</h3>
      <div id="collection" class="cards"></div>
    </div>
  </div>

  <div class="footer">
    <button id="navCapture" class="primary">Capture</button>
    <button id="navCollection">Collection</button>
    <button id="navTeam">Team</button>
    <button id="navWild">Wild Battle</button>
    <button id="navPvp" disabled>Local PvP (soon)</button>
  </div>
</div>

<!-- ====== Libraries ====== -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

<!-- ====== Game Script ====== -->
<script>
/* -------------------------------------------------------------------------- */
/*  Configuration & Data                                                     */
/* -------------------------------------------------------------------------- */

// Model + assets
const MODEL_URL = "model_real/";
const IMG_DIR   = "digital_images/";

// Your current labels (must match Teachable Machine classes)
const MONSTER_BOOK = {
  dog:      { name:"Dog",      element:"earth",  archetype:"guardian" , img:"dog"      },
  cat:      { name:"Cat",      element:"shadow", archetype:"assassin" , img:"cat"      },
  squirrel: { name:"Squirrel", element:"nature", archetype:"skirmish" , img:"squirrel" },
  fly:      { name:"Fly",      element:"air",    archetype:"plague"   , img:"fly"      },
  spider:   { name:"Spider",   element:"poison", archetype:"control"  , img:"spider"   },
  ladybug:  { name:"Ladybug",  element:"light",  archetype:"paladin"  , img:"ladybug"  },
};

// Archetype base stats (starting points)
const ARCHETYPE_BASE = {
  guardian: { hp: 90, atk: 55, def: 75, spd: 40, crit: 5,  evade: 5,  control: 5,  dot: 0  },
  assassin: { hp: 55, atk: 85, def: 45, spd: 85, crit: 20, evade: 15, control: 5,  dot: 0  },
  skirmish: { hp: 75, atk: 65, def: 60, spd: 80, crit: 10, evade: 10, control: 5,  dot: 0  },
  plague:   { hp: 50, atk: 55, def: 45, spd: 95, crit: 8,  evade: 12, control: 5,  dot: 25 },
  control:  { hp: 65, atk: 60, def: 70, spd: 55, crit: 6,  evade: 8,  control: 30, dot: 10 },
  paladin:  { hp: 95, atk: 60, def: 85, spd: 35, crit: 5,  evade: 5,  control: 8,  dot: 0  },
};

// Element advantages (simple wheel + obvious counters)
// Advantage = +20% damage; disadvantage = -20%
const ELEMENT_ADV = {
  nature: ["earth"],        // roots crack stone
  earth:  ["air"],          // ground vs wind
  air:    ["poison"],       // dilute toxins
  poison: ["nature"],       // blight plants
  light:  ["shadow"],       // light dispels darkness
  shadow: ["light"],        // shadow consumes light (symmetry)
};

// Rarity
const RARITY = {
  COMMON: { label:"Common", mult:[1.00, 1.05] },
  RARE:   { label:"Rare",   mult:[1.20, 1.30] }, // 5% chance
};
const RARE_CHANCE = 0.05;

// Storage keys
const STORE = {
  COLLECTION: "ml_collection_v1",
  TEAM:       "ml_team_v1",
  DUST:       "ml_dust_v1",
  FAVORITE:   "ml_favorite_v1",
};

// Globals
let model = null;
let stream = null;
let videoEl = null;

/* -------------------------------------------------------------------------- */
/*  Utilities                                                                 */
/* -------------------------------------------------------------------------- */

const $ = sel => document.querySelector(sel);
const el = (tag, props={}, ...kids) => {
  const n = document.createElement(tag);
  Object.assign(n, props);
  for (const k of kids) n.append(k);
  return n;
};
const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const uid = ()=>`m_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;

function sample(multRange){ // pick a multiplier in [a,b]
  const [a,b] = multRange;
  return a + Math.random()*(b-a);
}

function modStats(base, mult){
  const s = {...base};
  for (const k of Object.keys(s)) s[k] = Math.max(1, Math.round(s[k]*mult));
  return s;
}

function headToHead(attacker, defender){
  // returns damage factor (element advantage)
  let factor = 1.0;
  if (ELEMENT_ADV[attacker.element]?.includes(defender.element)) factor *= 1.2;
  if (ELEMENT_ADV[defender.element]?.includes(attacker.element)) factor *= 0.8;
  return factor;
}

function resolveImage(labelOrKey){
  // Try several extensions in order: .png.jpeg, .png, .jpg, .jpeg
  const base = MONSTER_BOOK[labelOrKey]?.img || labelOrKey;
  const candidates = [
    `${IMG_DIR}${base}.png.jpeg`,
    `${IMG_DIR}${base}.png`,
    `${IMG_DIR}${base}.jpg`,
    `${IMG_DIR}${base}.jpeg`,
  ];
  return new Promise(async (res)=>{
    for (const path of candidates){
      try {
        const r = await fetch(path, {cache:"no-store"});
        if (r.ok) return res(path);
      } catch(_) {}
    }
    // fallback emoji image
    res("data:image/svg+xml;utf8," + encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='200' height='140'>
         <rect width='100%' height='100%' fill='#111'/>
         <text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle'
           font-size='28' fill='#888'>üß©</text>
       </svg>`
    ));
  });
}

function logError(msg){
  const box = $("#log");
  box.style.display = "block";
  box.textContent = msg;
}
function clearError(){ $("#log").style.display = "none"; }

/* -------------------------------------------------------------------------- */
/*  Storage                                                                   */
/* -------------------------------------------------------------------------- */

function loadJSON(key, fallback){
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

const store = {
  get dust(){ return Number(localStorage.getItem(STORE.DUST) ?? 0); },
  set dust(v){ localStorage.setItem(STORE.DUST, String(v)); refreshHeader(); },

  get collection(){ return loadJSON(STORE.COLLECTION, []); },
  set collection(v){ saveJSON(STORE.COLLECTION, v); drawCollection(); },

  get team(){ return loadJSON(STORE.TEAM, []); },
  set team(v){ saveJSON(STORE.TEAM, v); drawTeam(); },

  get favorite(){ return localStorage.getItem(STORE.FAVORITE); },
  set favorite(id){ localStorage.setItem(STORE.FAVORITE, id ?? ""); refreshHeader(); },
};

function refreshHeader(){
  $("#dust").textContent = store.dust;
  $("#teamCount").textContent = store.team.length;
  const fav = store.collection.find(c=>c.id===store.favorite);
  $("#favName").textContent = fav ? fav.name : "None";
}

/* -------------------------------------------------------------------------- */
/*  Camera / Model                                                            */
/* -------------------------------------------------------------------------- */

async function loadModel(){
  try {
    // Quick sanity check that files exist
    for (const f of ["model.json","metadata.json","weights.bin"]){
      const r = await fetch(MODEL_URL + f, {cache:"no-store"});
      if (!r.ok) throw new Error(`Missing model file: ${f}`);
    }
    model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
    console.log("Model loaded", model);
  } catch (err) {
    logError("Failed to load model: " + err.message);
  }
}

async function startCamera(){
  if (!isSecureContext) $("#httpsWarn").style.display = "block";
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal:"environment" },
        width: {ideal:1280}, height:{ideal:720}
      }, audio:false
    });
    videoEl.srcObject = stream;
    await videoEl.play();
    clearError();
  } catch (err) {
    logError(`Camera error: ${err.name} ‚Äî ${err.message}`);
  }
}
function stopCamera(){
  if (stream){
    for (const t of stream.getTracks()) t.stop();
    stream = null;
  }
  videoEl.pause();
  videoEl.removeAttribute("srcObject");
}

/* -------------------------------------------------------------------------- */
/*  Monster Generation                                                        */
/* -------------------------------------------------------------------------- */

function rollRarity(){
  return Math.random() < RARE_CHANCE ? "rare" : "common";
}

function buildStats(label){
  const spec = MONSTER_BOOK[label];
  if (!spec) return null;
  const base = ARCHETYPE_BASE[spec.archetype];
  if (!base) return null;

  const rar = rollRarity();
  const pack = rar === "rare" ? RARITY.RARE : RARITY.COMMON;
  const mult = sample(pack.mult);
  const stats = modStats(base, mult);

  return {
    element: spec.element,
    archetype: spec.archetype,
    rarity: rar,
    rarityLabel: pack.label,
    ...stats,
    level: 1, xp: 0
  };
}

async function makeMonsterFromLabel(label){
  const spec = MONSTER_BOOK[label];
  if (!spec) {
    logError(`No monster mapping for label "${label}"`);
    return null;
  }
  const stats = buildStats(label);
  const image = await resolveImage(label);
  return {
    id: uid(),
    label, name: spec.name,
    image, ...stats,
    caughtAt: Date.now()
  };
}

/* -------------------------------------------------------------------------- */
/*  Prediction                                                                */
/* -------------------------------------------------------------------------- */

async function predictFromCanvas(canvas){
  if (!model){ await loadModel(); if (!model) return; }
  const preds = await model.predict(canvas);
  preds.sort((a,b)=>b.probability-a.probability);
  const top = preds[0];
  if (!top) { logError("No prediction result."); return; }
  const label = top.className?.toLowerCase();
  if (!label){ logError("Empty predicted label."); return; }
  clearError();

  const monster = await makeMonsterFromLabel(label);
  if (!monster) return;

  // Add to collection
  const col = store.collection;
  col.unshift(monster);
  store.collection = col;
}

function drawFromVideo(){
  const c = document.createElement("canvas");
  c.width = videoEl.videoWidth || 640;
  c.height = videoEl.videoHeight || 480;
  c.getContext("2d").drawImage(videoEl, 0, 0, c.width, c.height);
  return c;
}

/* -------------------------------------------------------------------------- */
/*  UI: Collection / Team                                                     */
/* -------------------------------------------------------------------------- */

function drawTeam(){
  const root = $("#team");
  root.innerHTML = "";
  const team = store.team.map(id => store.collection.find(m=>m.id===id)).filter(Boolean);
  for (let i=0;i<3;i++){
    const mon = team[i];
    const slot = el("div",{className:"team-slot" + (mon?" filled":"")});
    if (mon){
      slot.append(
        el("div",{}, el("div",{style:"font-weight:700"}, mon.name),
          el("div",{className:"small"}, `Lv ${mon.level} ‚Ä¢ ${mon.element}`))
      );
    }else{
      slot.textContent = "Empty";
    }
    root.append(slot);
  }
  refreshHeader();
}

function drawCollection(){
  const root = $("#collection");
  root.innerHTML = "";
  for (const m of store.collection){
    const head = el("div",{className:"card-head"},
      el("div",{style:"font-weight:700; flex:1"}, `${m.name}`),
      el("span",{className:"rarity " + (m.rarity==="rare"?"rare":"")}, m.rarityLabel),
    );
    const img = el("div",{className:"imgbox"}, el("img",{src:m.image,alt:m.name}));
    const stats = el("div",{className:"pad"},
      el("div",{className:"kv"},
        el("div",{}, "HP"), el("div",{}, String(m.hp)),
        el("div",{}, "ATK"), el("div",{}, String(m.atk)),
        el("div",{}, "DEF"), el("div",{}, String(m.def)),
        el("div",{}, "SPD"), el("div",{}, String(m.spd)),
        el("div",{}, "CRIT"), el("div",{}, String(m.crit)),
        el("div",{}, "EVADE"), el("div",{}, String(m.evade)),
      ),
      el("div",{className:"small", style:"margin-top:6px"},
        `Element: ${m.element} ‚Ä¢ Archetype: ${m.archetype}`),
      el("div",{className:"act"},
        // Assign to team
        el("button",{onclick:()=>{
          const t = store.team.slice();
          if (t.includes(m.id)) {
            // remove
            const idx = t.indexOf(m.id); t.splice(idx,1);
          } else {
            if (t.length>=3) { alert("Team is full. Remove another first."); return; }
            t.push(m.id);
          }
          store.team = t;
        }}, store.team.includes(m.id) ? "Remove from Team" : "Add to Team"),

        // Favorite
        el("button",{onclick:()=>{ store.favorite = m.id; }}, store.favorite===m.id?"‚òÖ Favorite":"‚òÜ Make Favorite"),

        // Upgrade
        el("button",{onclick:()=>{
          const cost = 10 * m.level;
          if (store.dust < cost) { alert(`Need ${cost} dust.`); return; }
          store.dust = store.dust - cost;
          m.level += 1;
          m.hp = Math.round(m.hp * 1.06);
          m.atk = Math.round(m.atk * 1.05);
          m.def = Math.round(m.def * 1.05);
          m.spd = Math.round(m.spd * 1.03);
          store.collection = store.collection.map(x=>x.id===m.id?m:x);
        }}, "Upgrade"),

        // Break down
        el("button",{onclick:()=>{
          if (!confirm("Break down this monster for dust? This cannot be undone.")) return;
          const gain = m.rarity==="rare" ? 25 : 10;
          store.dust = store.dust + gain;
          store.collection = store.collection.filter(x=>x.id!==m.id);
          store.team = store.team.filter(id=>id!==m.id);
          if (store.favorite===m.id) store.favorite = "";
        }}, "Break Down"),
      )
    );
    const card = el("div",{className:"card"}, head, img, stats);
    root.append(card);
  }
  drawTeam();
}

/* -------------------------------------------------------------------------- */
/*  Wild Battle (local demo)                                                  */
/* -------------------------------------------------------------------------- */

function pickTeamFighter(){
  const team = store.team.map(id => store.collection.find(m=>m.id===id)).filter(Boolean);
  return team[0] || team[1] || team[2] || store.collection[0] || null;
}

function simulateBattle(a,b){
  // Simple score function using stats + element factor
  const f = headToHead(a,b);
  const aScore = a.atk*1.1 + a.def*0.9 + a.spd*0.8 + a.hp*0.8 + a.crit*0.5 + a.evade*0.5;
  const bScore = b.atk*1.1 + b.def*0.9 + b.spd*0.8 + b.hp*0.8 + b.crit*0.5 + b.evade*0.5;
  const aAdj = aScore * f * (1 + Math.random()*0.1);
  const bAdj = bScore * (1 + Math.random()*0.1);
  return aAdj >= bAdj ? "A" : "B";
}

async function wildBattle(){
  const me = pickTeamFighter();
  if (!me){ alert("You need a monster (or a team member) to fight!"); return; }

  // Make a random wild opponent from your book
  const labels = Object.keys(MONSTER_BOOK);
  const randLabel = labels[randInt(0,labels.length-1)];
  const foe = await makeMonsterFromLabel(randLabel);

  const who = simulateBattle(me, foe);
  const win = (who==="A");

  alert(`${me.name} (You) ${win ? "defeated" : "lost to"} ${foe.name} (Wild)!
${win ? "+10 dust earned." : "+3 dust earned."}`);

  store.dust = store.dust + (win ? 10 : 3);
}

/* -------------------------------------------------------------------------- */
/*  Wire-up                                                                   */
/* -------------------------------------------------------------------------- */

async function onCaptureClick(){
  if (stream && !videoEl.paused && !videoEl.ended){
    const c = drawFromVideo();
    await predictFromCanvas(c);
  }else{
    logError("No webcam stream available.");
  }
}

function onUploadFile(ev){
  const file = ev.target.files?.[0];
  if (!file) return;
  const img = new Image();
  img.onload = async ()=>{
    const c = document.createElement("canvas");
    c.width = img.width; c.height = img.height;
    c.getContext("2d").drawImage(img,0,0);
    await predictFromCanvas(c);
  };
  img.src = URL.createObjectURL(file);
}

async function boot(){
  videoEl = $("#webcam");
  refreshHeader();
  drawCollection();

  await loadModel(); // load early so first prediction is fast

  $("#btnEnable").addEventListener("click", startCamera);
  $("#btnStop").addEventListener("click", stopCamera);
  $("#btnCapture").addEventListener("click", onCaptureClick);
  $("#fileInput").addEventListener("change", onUploadFile);

  // Footer
  $("#navWild").addEventListener("click", wildBattle);
  $("#navCapture").addEventListener("click", ()=>window.scrollTo({top:0,behavior:"smooth"}));
  $("#navCollection").addEventListener("click", ()=>document.querySelector("#collection").scrollIntoView({behavior:"smooth"}));
  $("#navTeam").addEventListener("click", ()=>document.querySelector("#team").scrollIntoView({behavior:"smooth"}));

  if (!isSecureContext) $("#httpsWarn").style.display = "block";
}
boot();
</script>
</body>
</html>
